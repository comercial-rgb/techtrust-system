// ============================================
// TECHTRUST AUTOSOLUTIONS - PRISMA SCHEMA
// ============================================
// Este é o schema ORM que mapeia para o PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Prisma supports a separate direct URL for some operations.
  // In our deployment (Render IPv4 + Supabase), the "direct" endpoint can be IPv6-only.
  // Keep this set to DATABASE_URL to avoid requiring an extra env var in production.
  directUrl = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  CLIENT
  PROVIDER
  ADMIN
}

enum AccountStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum Language {
  EN
  PT
  ES
}

enum ServiceType {
  SCHEDULED_MAINTENANCE
  REPAIR
  ROADSIDE_SOS
  INSPECTION
  DETAILING
}

enum ServiceRequestStatus {
  DRAFT
  SEARCHING_PROVIDERS
  QUOTES_RECEIVED
  QUOTE_ACCEPTED
  SCHEDULED
  IN_PROGRESS
  WAITING_APPROVAL
  COMPLETED
  CANCELLED
  EXPIRED
}

enum QuoteStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  REFUNDED
  FAILED
  CANCELLED
}

enum SubscriptionPlan {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum NotificationType {
  NEW_QUOTE
  QUOTE_ACCEPTED
  SERVICE_STARTED
  SERVICE_COMPLETED
  PAYMENT_RECEIVED
  NEW_REQUEST
  REMINDER
  SYSTEM_ALERT
  CHAT_MESSAGE
  SUPPLEMENT_REQUESTED
  SUPPLEMENT_APPROVED
  SUPPLEMENT_REJECTED
  INSUFFICIENT_FUNDS
  CANCELLATION_REQUESTED
  CANCELLATION_VALIDATED
  SERVICE_PHOTOS_UPLOADED
  TERMS_ACCEPTED
  RECEIPT_GENERATED
}

enum PaymentProcessor {
  STRIPE
  CHASE
}

enum SupplementStatus {
  REQUESTED
  APPROVED
  REJECTED
  HOLD_PLACED
  HOLD_FAILED
  CAPTURED
  VOIDED
}

enum CancellationRequestStatus {
  REQUESTED
  PENDING_PROVIDER_VALIDATION
  PROVIDER_CONFIRMED_NO_COST
  PROVIDER_REPORTED_COSTS
  APPROVED
  REJECTED
  COMPLETED
}

// ============================================
// MODELS
// ============================================

model User {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // Dados pessoais
  fullName String
  email    String  @unique
  phone    String  @unique
  passwordHash String
  cpf      String? // CPF (BR) or SSN (US)
  dateOfBirth DateTime?
  gender   String? // MALE, FEMALE, OTHER, PREFER_NOT_TO_SAY
  
  // Tipo e status
  role     UserRole      @default(CLIENT)
  status   AccountStatus @default(PENDING_VERIFICATION)
  language Language      @default(EN)
  
  // Verificação
  emailVerified Boolean   @default(false)
  phoneVerified Boolean   @default(false)
  otpCode       String?
  otpExpiresAt  DateTime?
  
  // Notificações
  fcmToken            String?
  pushEnabled         Boolean @default(true)
  emailNotifications  Boolean @default(true)
  smsNotifications    Boolean @default(false)
  
  // Localização
  address String?
  city    String?
  state   String?
  zipCode String?
  addressesJson Json? // JSON array of user addresses for cross-device sync
  preferencesJson Json? // JSON object for user preferences (spokenLanguages, etc.) for cross-device sync
  
  // Metadata
  lastLoginAt DateTime?
  
  // Relacionamentos
  providerProfile   ProviderProfile?
  vehicles          Vehicle[]
  serviceRequests   ServiceRequest[]
  quotes            Quote[]
  workOrdersAsCustomer WorkOrder[] @relation("CustomerWorkOrders")
  workOrdersAsProvider WorkOrder[] @relation("ProviderWorkOrders")
  paymentsAsCustomer   Payment[]   @relation("CustomerPayments")
  paymentsAsProvider   Payment[]   @relation("ProviderPayments")
  subscriptions     Subscription[]
  reviewsGiven      Review[]       @relation("CustomerReviews")
  reviewsReceived   Review[]       @relation("ProviderReviews")
  notifications     Notification[]
  paymentMethods    PaymentMethod[]
  chatMessagesFrom  ChatMessage[]  @relation("MessageFrom")
  chatMessagesTo    ChatMessage[]  @relation("MessageTo")
  supportTickets    SupportTicket[]
  supportMessages   SupportMessage[]
  articles          Article[]

  @@index([email])
  @@index([phone])
  @@index([role])
  @@map("users")
}

model ProviderProfile {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Informações do negócio
  businessName  String
  businessType  String?
  businessLicense String?
  taxId         String?
  
  // Contato
  businessPhone String?
  businessEmail String?
  website       String?
  
  // Endereço
  address String
  city    String
  state   String
  zipCode String
  
  // Raio de atendimento (em km)
  serviceRadiusKm Int @default(25)
  
  // Coordenadas GPS da oficina base
  baseLatitude  Decimal? @db.Decimal(10, 8)
  baseLongitude Decimal? @db.Decimal(11, 8)
  
  // Tipos de serviço oferecidos
  mobileService      Boolean @default(false)  // Atendimento no local do cliente
  roadsideAssistance Boolean @default(false)  // Assistência em rodovia (SOS)
  
  // Configuração de taxa de deslocamento
  freeKm        Int     @default(0)           // Km grátis inclusos
  extraFeePerKm Decimal @default(0) @db.Decimal(6, 2) // Taxa por km adicional
  
  // Especialidades (JSON array)
  specialties Json @default("[]")
  
  // Horário de funcionamento (JSON)
  businessHours Json?
  
  // Stripe
  stripeAccountId String? @unique
  stripeOnboardingCompleted Boolean @default(false)
  
  // Assinatura PRO
  hasProSubscription Boolean @default(false)
  proSubscriptionExpiresAt DateTime?
  
  // Verificação
  isVerified Boolean @default(false)
  verifiedAt DateTime?
  backgroundCheckCompleted Boolean @default(false)
  insuranceVerified Boolean @default(false)
  
  // Avaliações
  averageRating Decimal @default(0) @db.Decimal(3, 2)
  totalReviews  Int     @default(0)
  totalServicesCompleted Int @default(0)

  @@index([userId])
  @@index([isVerified])
  @@map("provider_profiles")
}

model Vehicle {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Identificação (agora opcionais)
  plateNumber String?
  plateState  String? // Estado da placa (EUA)
  vin         String? // VIN (Vehicle Identification Number)
  
  // Dados do veículo
  make  String
  model String
  year  Int
  color String?
  
  // Dados adicionais (auto-preenchidos via NHTSA vPIC ou manual)
  engineType String? // Tipo de motor
  fuelType   String? // Tipo de combustível
  bodyType   String? // Tipo de carroceria
  trim       String? // Versão/acabamento
  
  // Hodômetro
  currentMileage       Int?
  lastMileageUpdate    DateTime?
  
  // Foto
  photoUrl String?
  
  // Metadata NHTSA
  vinDecoded     Boolean @default(false) // Se VIN foi decodificado
  vinDecodedAt   DateTime? // Quando foi decodificado
  
  // Status
  isPrimary Boolean @default(false)
  isActive  Boolean @default(true)
  
  // Relacionamentos
  serviceRequests ServiceRequest[]
  workOrders      WorkOrder[]
  maintenanceSchedule VehicleMaintenanceSchedule[]

  @@index([userId])
  @@index([vin])
  @@map("vehicles")
}

model VehicleMaintenanceSchedule {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  
  // Tipo de manutenção
  maintenanceType String
  description     String?
  
  // Quando fazer
  recommendedMileage Int?
  recommendedMonths  Int?
  
  // Última vez
  lastServiceDate    DateTime?
  lastServiceMileage Int?
  
  // Próxima vez
  nextServiceDueDate    DateTime?
  nextServiceDueMileage Int?
  
  // Status
  isOverdue Boolean @default(false)
  notificationSent Boolean @default(false)

  @@index([vehicleId])
  @@index([isOverdue])
  @@map("vehicle_maintenance_schedule")
}

model ServiceRequest {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  requestNumber String @unique
  
  // Cliente e veículo
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  
  // Tipo de serviço
  serviceType ServiceType
  title       String
  description String?
  
  // Localização
  serviceLocationType String
  customerAddress     String?
  
  // Coordenadas GPS do local de serviço
  serviceLatitude  Decimal? @db.Decimal(10, 8)
  serviceLongitude Decimal? @db.Decimal(11, 8)
  locationType     String?  // IN_SHOP, ON_SITE, ROADSIDE
  
  // Preferências
  preferredDate     DateTime?
  preferredTime     DateTime?
  flexibleSchedule  Boolean @default(false)
  
  // Urgência
  isUrgent Boolean @default(false)
  
  // Anexos (JSON array de URLs)
  attachments Json @default("[]")
  
  // Status
  status ServiceRequestStatus @default(DRAFT)
  
  // Cotações
  quotesCount      Int @default(0)
  maxQuotes        Int @default(5)
  quoteDeadline    DateTime?
  
  // Orçamento aceito
  acceptedQuoteId String?
  
  // Datas importantes
  expiresAt    DateTime?
  scheduledFor DateTime?
  startedAt    DateTime?
  completedAt  DateTime?
  cancelledAt  DateTime?
  cancellationReason String?
  
  // Relacionamentos
  quotes       Quote[]
  workOrders   WorkOrder[]
  chatMessages ChatMessage[] @relation("ServiceRequestChats")

  @@index([userId])
  @@index([vehicleId])
  @@index([status])
  @@index([serviceType])
  @@index([createdAt])
  @@map("service_requests")
}

model Quote {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  quoteNumber String @unique
  
  // Relacionamentos
  serviceRequestId String
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  providerId       String
  provider         User           @relation(fields: [providerId], references: [id], onDelete: Cascade)
  
  // Valores
  partsCost      Decimal @db.Decimal(10, 2)
  laborCost      Decimal @db.Decimal(10, 2)
  additionalFees Decimal @default(0) @db.Decimal(10, 2)
  taxAmount      Decimal @default(0) @db.Decimal(10, 2)
  totalAmount    Decimal @db.Decimal(10, 2)
  
  // Distância e taxa de deslocamento
  distanceKm  Decimal? @db.Decimal(7, 2)  // Distância calculada em km
  travelFee   Decimal @default(0) @db.Decimal(10, 2)  // Taxa de deslocamento
  
  // Detalhes (JSON)
  partsList         Json
  laborDescription  String?
  estimatedHours    Decimal? @db.Decimal(4, 2)
  
  // Prazo
  estimatedCompletionTime String?
  availableDate           DateTime?
  availableTime           DateTime?
  
  // Garantia
  warrantyMonths      Int?
  warrantyMileage     Int?
  warrantyDescription String?
  
  // Notas
  notes String?
  
  // Status
  status QuoteStatus @default(PENDING)
  
  // Validade
  validUntil DateTime
  
  // Datas
  viewedByCustomerAt DateTime?
  acceptedAt         DateTime?
  rejectedAt         DateTime?
  expiredAt          DateTime?
  
  // Relacionamentos
  workOrders WorkOrder[]

  @@unique([serviceRequestId, providerId])
  @@index([serviceRequestId])
  @@index([providerId])
  @@index([status])
  @@map("quotes")
}

model WorkOrder {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  orderNumber String @unique
  
  // Relacionamentos
  serviceRequestId String
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  quoteId          String
  quote            Quote          @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  customerId       String
  customer         User           @relation("CustomerWorkOrders", fields: [customerId], references: [id])
  providerId       String
  provider         User           @relation("ProviderWorkOrders", fields: [providerId], references: [id])
  vehicleId        String
  vehicle          Vehicle        @relation(fields: [vehicleId], references: [id])
  
  // Status
  status String @default("PENDING_START")
  
  // Valores
  originalAmount   Decimal @db.Decimal(10, 2)
  additionalAmount Decimal @default(0) @db.Decimal(10, 2)
  finalAmount      Decimal @db.Decimal(10, 2)
  
  // Aditivos (JSON)
  additives Json @default("[]")
  
  // Hodômetro
  startMileage Int?
  endMileage   Int?
  
  // Datas
  scheduledFor          DateTime?
  startedAt             DateTime?
  completedAt           DateTime?
  approvedByCustomerAt  DateTime?
  cancelledAt           DateTime?
  
  // Fotos (JSON arrays)
  beforePhotos  Json @default("[]")
  duringPhotos  Json @default("[]")
  afterPhotos   Json @default("[]")
  
  // Notas
  providerNotes String?
  customerNotes String?
  
  // Presença do cliente
  clientPresent Boolean?
  serviceLocationType String? // IN_SHOP, MOBILE, REMOTE
  
  // Finalização pelo fornecedor
  serviceCompletedByProvider Boolean @default(false)
  serviceCompletionNotes     String?
  
  // Aprovação do cliente com termos legais
  termsAcceptedAt           DateTime?
  termsAcceptedIp           String?
  fraudDisclaimerAcceptedAt DateTime?
  serviceApprovalSignature  String? // nome digitado como assinatura
  
  // Garantia
  warrantyMonths    Int?
  warrantyMileage   Int?
  warrantyExpiresAt DateTime?
  
  // Relacionamentos
  payments             Payment[]
  reviews              Review[]
  supplements          PaymentSupplement[]
  cancellationRequests CancellationRequest[]

  @@index([serviceRequestId])
  @@index([customerId])
  @@index([providerId])
  @@index([status])
  @@map("work_orders")
}

model Payment {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  paymentNumber String @unique
  
  // Relacionamentos
  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  customerId  String
  customer    User      @relation("CustomerPayments", fields: [customerId], references: [id])
  providerId  String
  provider    User      @relation("ProviderPayments", fields: [providerId], references: [id])
  
  // Processador de pagamento
  paymentProcessor PaymentProcessor @default(STRIPE)
  
  // Stripe
  stripePaymentIntentId String @unique
  stripeChargeId        String?
  stripeTransferId      String?
  
  // Chase (futuro)
  chaseTransactionId String?
  
  // Valores
  subtotal      Decimal @db.Decimal(10, 2)
  platformFee   Decimal @db.Decimal(10, 2)
  processingFee Decimal @db.Decimal(10, 2) // Stripe ou Chase fee
  totalAmount   Decimal @db.Decimal(10, 2)
  providerAmount Decimal @db.Decimal(10, 2)
  
  // Status
  status PaymentStatus @default(PENDING)
  
  // Tipo do pagamento
  paymentType String @default("SERVICE") // SERVICE, SUPPLEMENT, CANCELLATION_FEE
  parentPaymentId String? // para suplementos, referencia o pagamento original
  
  // Método de pagamento
  paymentMethodId String?
  cardLast4       String?
  cardBrand       String?
  cardType        String? // credit, debit
  
  // Datas
  authorizedAt           DateTime?
  capturedAt             DateTime?
  refundedAt             DateTime?
  transferredToProviderAt DateTime?
  
  // Reembolso
  refundAmount Decimal? @db.Decimal(10, 2)
  refundReason String?
  
  // Recibo
  receipt Receipt?

  @@index([workOrderId])
  @@index([customerId])
  @@index([providerId])
  @@index([status])
  @@map("payments")
}

model Subscription {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Plano
  plan  SubscriptionPlan   @default(FREE)
  price Decimal            @default(0) @db.Decimal(10, 2)
  
  // Stripe
  stripeSubscriptionId String?  @unique
  stripeCustomerId     String?
  
  // Limites
  maxVehicles                 Int  @default(1)
  maxServiceRequestsPerMonth  Int?
  
  // Status
  status SubscriptionStatus @default(ACTIVE)
  
  // Datas
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  trialEnd           DateTime?
  cancelledAt        DateTime?
  cancellationReason String?
  
  // Uso no período
  vehiclesRegistered          Int @default(0)
  serviceRequestsThisMonth    Int @default(0)

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

model Review {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relacionamentos
  workOrderId String @unique
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  customerId  String
  customer    User      @relation("CustomerReviews", fields: [customerId], references: [id])
  providerId  String
  provider    User      @relation("ProviderReviews", fields: [providerId], references: [id])
  
  // Avaliação do cliente
  customerRating      Int
  customerComment     String?
  customerReviewDate  DateTime @default(now())
  
  // Avaliação do fornecedor
  providerRating      Int?
  providerComment     String?
  providerReviewDate  DateTime?
  
  // Categorias
  qualityRating       Int?
  timelinessRating    Int?
  communicationRating Int?
  valueRating         Int?
  
  // Flags
  isVerified            Boolean @default(true)
  isFeatured            Boolean @default(false)
  flaggedAsInappropriate Boolean @default(false)
  
  // Resposta do fornecedor
  providerResponse     String?
  providerResponseDate DateTime?

  @@index([workOrderId])
  @@index([customerId])
  @@index([providerId])
  @@index([customerRating])
  @@map("reviews")
}

model Notification {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Tipo e conteúdo
  type    NotificationType
  title   String
  message String
  
  // Relacionamentos opcionais
  relatedServiceRequestId String?
  relatedQuoteId          String?
  relatedWorkOrderId      String?
  
  // Data adicional (JSON)
  data Json @default("{}")
  
  // Status
  isRead Boolean  @default(false)
  readAt DateTime?
  
  // Canais
  sentViaPush  Boolean @default(false)
  sentViaEmail Boolean @default(false)
  sentViaSms   Boolean @default(false)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

model PaymentMethod {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Tipo de pagamento
  type         String  @default("credit") // credit, debit, pix
  
  // Stripe (opcional - para integração futura)
  stripePaymentMethodId String? @unique
  
  // Dados do cartão
  cardBrand    String?
  cardLast4    String?
  cardExpMonth Int?
  cardExpYear  Int?
  holderName   String?
  
  // PIX
  pixKey       String?
  
  // Billing
  billingName String?
  billingZip  String?
  
  // Status
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  @@index([userId])
  @@index([userId, isDefault])
  @@map("payment_methods")
}

model ChatMessage {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  
  // Participantes
  fromUserId String
  fromUser   User   @relation("MessageFrom", fields: [fromUserId], references: [id])
  toUserId   String
  toUser     User   @relation("MessageTo", fields: [toUserId], references: [id])
  
  // Contexto (opcional)
  workOrderId String?
  
  // Conversation identifier (groups messages between two users for a context)
  conversationId String?
  
  // Link to service request (associates chat with a specific request)
  serviceRequestId String?
  serviceRequest   ServiceRequest? @relation("ServiceRequestChats", fields: [serviceRequestId], references: [id])
  
  // Conteúdo
  message String
  
  // Anexos (JSON array)
  attachments Json @default("[]")
  
  // Status
  isRead Boolean  @default(false)
  readAt DateTime?

  @@index([fromUserId])
  @@index([toUserId])
  @@index([workOrderId])
  @@index([conversationId])
  @@index([serviceRequestId])
  @@index([createdAt])
  @@map("chat_messages")
}

// ============================================
// SUPPORT TICKETS (Customer support conversations)
// ============================================

enum SupportTicketStatus {
  OPEN
  WAITING_ADMIN
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
}

model SupportTicket {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Ticket identifier (e.g., SUP-000001)
  ticketNumber String @unique
  
  // Customer
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Topic / category
  topic    String   // payments, services, account, vehicles, technical, other
  subject  String
  
  // Customer language (detected/selected)
  language String @default("en") // en, pt, es
  
  // Status
  status SupportTicketStatus @default(OPEN)
  
  // Admin assigned
  assignedAdminId String?
  
  // Resolution
  resolvedAt DateTime?
  closedAt   DateTime?
  
  // Messages
  messages SupportMessage[]

  @@index([userId])
  @@index([status])
  @@index([ticketNumber])
  @@index([createdAt])
  @@map("support_tickets")
}

model SupportMessage {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  
  // Ticket
  ticketId String
  ticket   SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  // Sender
  senderId String
  sender   User   @relation(fields: [senderId], references: [id])
  senderRole String // CLIENT, ADMIN, SYSTEM
  
  // Content
  message String
  attachments Json @default("[]")
  
  // Status
  isRead Boolean  @default(false)
  readAt DateTime?

  @@index([ticketId])
  @@index([senderId])
  @@index([createdAt])
  @@map("support_messages")
}

model SystemSettings {
  key         String   @id
  value       Json
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  @@map("system_settings")
}

// ============================================
// CONTENT MANAGEMENT - Gerenciamento de Conteúdo
// ============================================

// Banners/Publicidade
model Banner {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  title       String
  subtitle    String?
  imageUrl    String
  linkUrl     String?
  linkType    String?  // internal, external, none
  
  // Ordenação e visibilidade
  position    Int      @default(0)
  isActive    Boolean  @default(true)
  
  // Período de exibição
  startDate   DateTime?
  endDate     DateTime?
  
  // Audiência
  targetAudience String @default("all") // all, customers, providers
  
  // Criado por
  createdById String?
  
  @@index([isActive])
  @@index([position])
  @@map("banners")
}

// Ofertas Especiais
model SpecialOffer {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  title       String
  description String
  imageUrl    String?
  
  // Desconto
  discountType  String   // percentage, fixed, free
  discountValue Decimal? @db.Decimal(10, 2)
  discountLabel String   // "15% OFF", "FREE", "$20 OFF"
  
  // Preços para exibição
  originalPrice   Decimal? @db.Decimal(10, 2)
  discountedPrice Decimal? @db.Decimal(10, 2)
  
  // Validade
  validFrom   DateTime?
  validUntil  DateTime?
  
  // Código promocional (opcional)
  promoCode   String?
  
  // Configurações
  position    Int      @default(0)
  isActive    Boolean  @default(true)
  isFeatured  Boolean  @default(false)
  
  // Limite de uso
  usageLimit  Int?
  usageCount  Int      @default(0)
  
  // Service type restrictions - NEW FIELDS
  serviceType    String?  // oil, brake, tire, engine, etc.
  vehicleTypes   Json     @default("[]") // ["Car", "SUV", "Pickup", "Van", "Light Truck"]
  fuelTypes      Json     @default("[]") // ["Gasoline", "Diesel", "Hybrid", "Electric"]
  
  // Legacy field (keep for backwards compatibility)
  applicableServices Json @default("[]") // array de ServiceType
  
  // Criado por
  createdById String?
  
  @@index([isActive])
  @@index([validUntil])
  @@index([serviceType])
  @@map("special_offers")
}

// Artigos/Dicas
model Article {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?
  
  title       String
  slug        String   @unique
  excerpt     String
  content     String   @db.Text
  imageUrl    String?
  
  // Categorização
  category    String   // tips, maintenance, news, safety, technology
  tags        Json     @default("[]")
  
  // Meta
  readTime    String?  // "5 min read"
  
  // Configurações
  isPublished Boolean  @default(false)
  isFeatured  Boolean  @default(false)
  position    Int      @default(0)
  
  // Estatísticas
  viewCount   Int      @default(0)
  likeCount   Int      @default(0)
  
  // Autor
  authorId    String?
  author      User?    @relation(fields: [authorId], references: [id])
  
  @@index([isPublished])
  @@index([category])
  @@index([slug])
  @@map("articles")
}

// Avisos/Notícias Importantes
model Notice {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  title       String
  message     String   @db.Text
  
  // Tipo e aparência
  type        String   @default("info") // info, warning, alert, success
  icon        String?  // nome do ícone
  
  // Visibilidade
  isActive    Boolean  @default(true)
  isPinned    Boolean  @default(false)
  position    Int      @default(0)
  
  // Período de exibição
  startDate   DateTime?
  endDate     DateTime?
  
  // Audiência
  targetAudience String @default("all") // all, customers, providers
  
  // Ação (opcional)
  actionLabel String?
  actionUrl   String?
  
  // Criado por
  createdById String?
  
  @@index([isActive])
  @@index([type])
  @@map("notices")
}

// Templates de Planos de Assinatura
model SubscriptionPlanTemplate {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Identificador único do plano (free, basic, premium, enterprise)
  planKey String @unique
  
  // Informações do plano
  name        String  // Nome do plano
  description String? // Descrição
  
  // Preços
  monthlyPrice Decimal @default(0) @db.Decimal(10, 2)
  yearlyPrice  Decimal @default(0) @db.Decimal(10, 2)
  
  // Limites
  vehicleLimit              Int @default(1)
  serviceRequestsPerMonth   Int? // null = unlimited
  
  // Features (JSON array de strings)
  features Json @default("[]")
  
  // Status
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)
  position   Int     @default(0)
  
  @@index([isActive])
  @@index([position])
  @@map("subscription_plan_templates")
}

// Zonas de Cobertura (Coverage Zones)
model CoverageZone {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relacionamento com o provider
  providerId String
  
  // Informações da zona
  name   String  // Ex: "Zona Sul", "Centro", "ABC Paulista"
  region String? // Ex: "São Paulo", "Grande SP"
  
  // Status
  active Boolean @default(true)
  
  // Coordenadas do polígono (JSON array de {lat, lng})
  // Para fase 1, pode ser null - apenas tag de marketing
  polygonCoordinates Json?
  
  @@index([providerId])
  @@index([active])
  @@map("coverage_zones")
}

// ============================================
// PAYMENT SUPPLEMENTS (Complemento de valor)
// ============================================
model PaymentSupplement {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  supplementNumber String @unique
  
  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  
  // Quem pediu e valores
  requestedByProviderId String
  description           String
  additionalAmount      Decimal @db.Decimal(10, 2)
  
  // Detalhamento
  additionalParts Json @default("[]")
  additionalLabor Decimal @default(0) @db.Decimal(10, 2)
  reason          String? // motivo detalhado
  
  // Status do suplemento
  status SupplementStatus @default(REQUESTED)
  
  // Aprovação do cliente
  approvedByCustomerAt DateTime?
  rejectedByCustomerAt DateTime?
  customerNote         String?
  
  // Hold (pré-autorização do suplemento)
  stripePaymentIntentId String?
  holdPlacedAt          DateTime?
  holdFailedReason      String?
  holdAmount            Decimal? @db.Decimal(10, 2)
  capturedAt            DateTime?
  
  // Se hold falhou, continuar com orçamento original
  proceedWithOriginal Boolean @default(false)
  
  @@index([workOrderId])
  @@index([status])
  @@map("payment_supplements")
}

// ============================================
// CANCELLATION REQUESTS (Pedido de cancelamento)
// ============================================
model CancellationRequest {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  
  // Cliente que pediu cancelamento
  requestedByCustomerId String
  reason                String?
  
  // Status do pedido
  status CancellationRequestStatus @default(REQUESTED)
  
  // Validação do fornecedor
  providerValidation       String? // descrição do que foi feito
  providerHasIncurredCosts Boolean?
  providerReportedCosts    Decimal? @db.Decimal(10, 2)
  providerEvidencePhotos   Json @default("[]")
  providerValidatedAt      DateTime?
  
  // Taxa de cancelamento calculada
  cancellationFeePercent Decimal? @db.Decimal(5, 2)
  cancellationFeeAmount  Decimal? @db.Decimal(10, 2)
  
  // Resolução
  resolvedAt DateTime?
  resolvedBy String? // admin ou sistema
  resolution String? // FULL_REFUND, PARTIAL_REFUND, NO_REFUND, FEE_CHARGED
  
  @@index([workOrderId])
  @@index([status])
  @@map("cancellation_requests")
}

// ============================================
// RECEIPTS (Recibos de pagamento)
// ============================================
model Receipt {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  
  receiptNumber String @unique
  
  // Pagamento associado
  paymentId String  @unique
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  
  // Dados do recibo
  customerName  String
  customerEmail String
  providerName  String
  providerBusinessName String?
  
  // Serviço
  serviceDescription String
  vehicleInfo        String
  orderNumber        String
  
  // Valores detalhados
  subtotal      Decimal @db.Decimal(10, 2)
  platformFee   Decimal @db.Decimal(10, 2)
  processingFee Decimal @db.Decimal(10, 2)
  totalAmount   Decimal @db.Decimal(10, 2)
  supplementsTotal Decimal @default(0) @db.Decimal(10, 2)
  
  // Processador
  paymentProcessor  PaymentProcessor
  paymentMethodInfo String // "Visa ending in 4242"
  
  // Termos aceitos
  termsAcceptedAt           DateTime?
  fraudDisclaimerAcceptedAt DateTime?
  
  // PDF (futuro)
  pdfUrl String?
  
  @@index([paymentId])
  @@map("receipts")
}